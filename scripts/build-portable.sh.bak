#!/bin/bash
# OpenClaw Portable Package Builder v1.0.1
# æ”¯æŒè‡ªå®šä¹‰è·¯å¾„é…ç½®

set -e

VERSION="1.0.1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# é»˜è®¤é…ç½®ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
: "${OPENCLAW_INSTALL_DIR:=/home/$(whoami)/.nvm/versions/node/v22.22.0/lib/node_modules/openclaw}"
: "${OPENCLAW_CONFIG_DIR:=/home/$(whoami)/.openclaw}"
: "${OUTPUT_DIR:=$(pwd)/openclaw-portable-output}"
: "${CLEAN_CONFIG_FILE:=${SCRIPT_DIR}/../clean/config/openclaw.json}"

NODE_VERSION="22.22.0"

echo "=========================================="
echo "OpenClaw Portable Package Builder v${VERSION}"
echo "=========================================="

# æ£€æŸ¥ä¾èµ–
check_deps() {
    echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
    
    local deps_ok=true
    
    if ! command -v cp >/dev/null 2>&1; then
        echo "  âŒ ç¼ºå°‘: cp"
        deps_ok=false
    fi
    
    if ! command -v mkdir >/dev/null 2>&1; then
        echo "  âŒ ç¼ºå°‘: mkdir"
        deps_ok=false
    fi
    
    if [ "$deps_ok" = false ]; then
        echo "âŒ ä¾èµ–æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
    
    echo "  âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥æºæ–‡ä»¶
check_source() {
    echo ""
    echo "ğŸ“ æ£€æŸ¥æºæ–‡ä»¶..."
    
    if [ ! -d "$OPENCLAW_INSTALL_DIR" ]; then
        echo "  âŒ OpenClaw å®‰è£…ç›®å½•ä¸å­˜åœ¨: $OPENCLAW_INSTALL_DIR"
        echo "     å¯é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®:"
        echo "     export OPENCLAW_INSTALL_DIR=/path/to/openclaw"
        exit 1
    fi
    echo "  âœ… OpenClaw å®‰è£…ç›®å½•: $OPENCLAW_INSTALL_DIR"
    
    if [ ! -d "$OPENCLAW_CONFIG_DIR" ]; then
        echo "  âš ï¸  é…ç½®ç›®å½•ä¸å­˜åœ¨: $OPENCLAW_CONFIG_DIR"
    else
        echo "  âœ… é…ç½®ç›®å½•: $OPENCLAW_CONFIG_DIR"
    fi
}

# æ˜¾ç¤ºé…ç½®
show_config() {
    echo ""
    echo "âš™ï¸  å½“å‰é…ç½®:"
    echo "    OpenClaw å®‰è£…: $OPENCLAW_INSTALL_DIR"
    echo "    é…ç½®ç›®å½•: $OPENCLAW_CONFIG_DIR"
    echo "    è¾“å‡ºç›®å½•: $OUTPUT_DIR"
}

# å‡†å¤‡ç›®å½•
prepare() {
    echo ""
    echo "ğŸ—‚ï¸  å‡†å¤‡è¾“å‡ºç›®å½•..."
    rm -rf "$OUTPUT_DIR"
    mkdir -p "$OUTPUT_DIR/clean/openclaw/app"
    mkdir -p "$OUTPUT_DIR/clean/openclaw/.openclaw"
    mkdir -p "$OUTPUT_DIR/full/openclaw/app"
    mkdir -p "$OUTPUT_DIR/full/openclaw/.openclaw"
    echo "  âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
}

# æ„å»ºçº¯å‡€ç‰ˆ
build_clean() {
    echo ""
    echo "ğŸ“¦ æ„å»ºçº¯å‡€ç‰ˆ..."
    
    # å¤åˆ¶åº”ç”¨
    cp -r "$OPENCLAW_INSTALL_DIR"/* "$OUTPUT_DIR/clean/openclaw/app/" 2>/dev/null || {
        echo "  âŒ å¤åˆ¶åº”ç”¨å¤±è´¥"
        exit 1
    }
    echo "  âœ… å¤åˆ¶ OpenClaw åº”ç”¨"
    
    # å¤åˆ¶é…ç½®
    if [ -f "$CLEAN_CONFIG_FILE" ]; then
        cp "$CLEAN_CONFIG_FILE" "$OUTPUT_DIR/clean/openclaw/.openclaw/"
        echo "  âœ… å¤åˆ¶çº¯å‡€ç‰ˆé…ç½®"
    else
        echo "  âš ï¸  ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆæœªæ‰¾åˆ° $CLEAN_CONFIG_FILEï¼‰"
    fi
    
    # åˆ›å»ºå¯åŠ¨è„šæœ¬ - ä½¿ç”¨ printf é¿å… heredoc é—®é¢˜
    printf '%s\n' '#!/bin/bash' \
        '# OpenClaw Clean Version Startup' \
        '' \
        'SCRIPT="$(cd "$(dirname "$0")" \&\& pwd)/openclaw"' \
        '' \
        '# æŸ¥æ‰¾ Node.js' \
        'if command -v node \>/dev/null 2\>\&1; then' \
        '    NODE_CMD="node"' \
        'elif [ -x "$SCRIPT/../node/bin/node" ]; then' \
        '    NODE_CMD="$SCRIPT/../node/bin/node"' \
        'elif [ -x "$HOME/.nvm/versions/node/v22.22.0/bin/node" ]; then' \
        '    NODE_CMD="$HOME/.nvm/versions/node/v22.22.0/bin/node"' \
        'else' \
        '    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Node.js"' \
        '    echo "   è¯·å…ˆå®‰è£… Node.js 22.x: ./install-node.sh"' \
        '    exit 1' \
        'fi' \
        '' \
        '# æ£€æŸ¥åº”ç”¨' \
        'if [ ! -f "$SCRIPT/app/openclaw.mjs" ]; then' \
        '    echo "âŒ é”™è¯¯: OpenClaw åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨"' \
        '    exit 1' \
        'fi' \
        '' \
        'mkdir -p "$SCRIPT/.openclaw/workspace"' \
        'export OPENCLAW_CONFIG="$SCRIPT/.openclaw/openclaw.json"' \
        '' \
        'echo "ğŸš€ å¯åŠ¨ OpenClaw (çº¯å‡€ç‰ˆ)..."' \
        'echo "   é…ç½®æ–‡ä»¶: $OPENCLAW_CONFIG"' \
        'echo "   Node.js: $NODE_CMD"' \
        'echo ""' \
        'exec "$NODE_CMD" "$SCRIPT/app/openclaw.mjs" gateway start "$@"' \
        \> "$OUTPUT_DIR/clean/start.sh"
    
    chmod +x "$OUTPUT_DIR/clean/start.sh"
    echo "  âœ… åˆ›å»ºå¯åŠ¨è„šæœ¬"
}

# æ„å»ºå®Œæ•´ç‰ˆ
build_full() {
    echo ""
    echo "ğŸ“¦ æ„å»ºå®Œæ•´ç‰ˆ..."
    
    # å¤åˆ¶åº”ç”¨
    cp -r "$OPENCLAW_INSTALL_DIR"/* "$OUTPUT_DIR/full/openclaw/app/" 2>/dev/null || {
        echo "  âŒ å¤åˆ¶åº”ç”¨å¤±è´¥"
        exit 1
    }
    echo "  âœ… å¤åˆ¶ OpenClaw åº”ç”¨"
    
    # å¤åˆ¶é…ç½®
    if [ -d "$OPENCLAW_CONFIG_DIR" ]; then
        cp -r "$OPENCLAW_CONFIG_DIR"/* "$OUTPUT_DIR/full/openclaw/.openclaw/" 2>/dev/null || true
        echo "  âœ… å¤åˆ¶å®Œæ•´é…ç½®"
    else
        echo "  âš ï¸  é…ç½®ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
    fi
    
    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    printf '%s\n' '#!/bin/bash' \
        '# OpenClaw Full Version Startup' \
        '' \
        'SCRIPT="$(cd "$(dirname "$0")" \&\& pwd)/openclaw"' \
        '' \
        '# æŸ¥æ‰¾ Node.js' \
        'if command -v node \>/dev/null 2\>\&1; then' \
        '    NODE_CMD="node"' \
        'elif [ -x "$SCRIPT/../node/bin/node" ]; then' \
        '    NODE_CMD="$SCRIPT/../node/bin/node"' \
        'elif [ -x "$HOME/.nvm/versions/node/v22.22.0/bin/node" ]; then' \
        '    NODE_CMD="$HOME/.nvm/versions/node/v22.22.0/bin/node"' \
        'else' \
        '    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Node.js"' \
        '    echo "   è¯·å…ˆå®‰è£… Node.js 22.x: ./install-node.sh"' \
        '    exit 1' \
        'fi' \
        '' \
        '# æ£€æŸ¥åº”ç”¨' \
        'if [ ! -f "$SCRIPT/app/openclaw.mjs" ]; then' \
        '    echo "âŒ é”™è¯¯: OpenClaw åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨"' \
        '    exit 1' \
        'fi' \
        '' \
        'export OPENCLAW_CONFIG="$SCRIPT/.openclaw/openclaw.json"' \
        '' \
        'echo "ğŸš€ å¯åŠ¨ OpenClaw (å®Œæ•´ç‰ˆ)..."' \
        'echo "   é…ç½®æ–‡ä»¶: $OPENCLAW_CONFIG"' \
        'echo "   Node.js: $NODE_CMD"' \
        'echo ""' \
        'exec "$NODE_CMD" "$SCRIPT/app/openclaw.mjs" gateway start "$@"' \
        \> "$OUTPUT_DIR/full/start.sh"
    
    chmod +x "$OUTPUT_DIR/full/start.sh"
    echo "  âœ… åˆ›å»ºå¯åŠ¨è„šæœ¬"
}

# åˆ›å»ºè¾…åŠ©æ–‡ä»¶
create_aux() {
    echo ""
    echo "ğŸ“„ åˆ›å»ºè¾…åŠ©æ–‡ä»¶..."
    
    # install-node.sh
    cat \> "$OUTPUT_DIR/install-node.sh" \<\< 'NODEEOF'
#!/bin/bash
# Node.js å®‰è£…è„šæœ¬

echo "=========================================="
echo "Node.js 22.22.0 å®‰è£…"
echo "=========================================="

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if command -v node \>/dev/null 2\>\&1; then
    echo "âœ… Node.js å·²å®‰è£…: $(node --version)"
    exit 0
fi

# å®‰è£… NVM
if ! command -v nvm \>/dev/null 2\>\&1; then
    echo "ğŸ“¦ å®‰è£… NVM..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] \&\& \. "$NVM_DIR/nvm.sh"
fi

# å®‰è£… Node.js
echo "ğŸ“¦ å®‰è£… Node.js 22.22.0..."
nvm install 22.22.0
nvm use 22.22.0

node --version
npm --version

echo "âœ… Node.js å®‰è£…å®Œæˆï¼"
NODEEOF
    chmod +x "$OUTPUT_DIR/install-node.sh"
    
    # check-env.sh
    cat \> "$OUTPUT_DIR/check-env.sh" \<\< 'CHECKEOF'
#!/bin/bash
# ç¯å¢ƒæ£€æŸ¥è„šæœ¬

echo "=========================================="
echo "OpenClaw ç¯å¢ƒæ£€æŸ¥"
echo "=========================================="

# æ£€æŸ¥ Node.js
if command -v node \>/dev/null 2\>\&1; then
    echo "âœ… Node.js: $(node --version)"
else
    echo "âŒ Node.js æœªå®‰è£…"
    exit 1
fi

# æ£€æŸ¥ OpenClaw
if command -v openclaw \>/dev/null 2\>\&1; then
    echo "âœ… OpenClaw: $(openclaw --version)"
else
    echo "âš ï¸  OpenClaw ä¸åœ¨ PATH ä¸­ï¼ˆä¾¿æºç‰ˆå¯å¿½ç•¥ï¼‰"
fi

echo ""
echo "ç›®å½•ç»“æ„:"
ls -la ./clean/ ./full/ 2\>/dev/null || echo "  æœªæ‰¾åˆ° clean/full ç›®å½•"

echo ""
echo "âœ… æ£€æŸ¥å®Œæˆ"
CHECKEOF
    chmod +x "$OUTPUT_DIR/check-env.sh"
    
    echo "  âœ… install-node.sh"
    echo "  âœ… check-env.sh"
}

# åˆ›å»º README
create_readme() {
    cat \> "$OUTPUT_DIR/README.md" \<\< 'READMEOF'
# OpenClaw ä¾¿æºç‰ˆ v1.0.1

OpenClaw ä¾¿æºéƒ¨ç½²åŒ…ï¼Œæ”¯æŒè‡ªå®šä¹‰è·¯å¾„é…ç½®ã€‚

## ç‰ˆæœ¬è¯´æ˜

- **çº¯å‡€ç‰ˆ (clean)**: æ— ä¸ªäººé…ç½®ï¼Œéœ€è‡ªè¡Œè®¾ç½®
- **å®Œæ•´ç‰ˆ (full)**: åŒ…å«å®Œæ•´é…ç½®

## å¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥ç¯å¢ƒ
```bash
./check-env.sh
```

### 2. å®‰è£… Node.jsï¼ˆå¦‚éœ€è¦ï¼‰
```bash
./install-node.sh
```

### 3. å¯åŠ¨æœåŠ¡

**çº¯å‡€ç‰ˆï¼š**
```bash
cd clean
./start.sh
```

**å®Œæ•´ç‰ˆï¼š**
```bash
cd full
./start.sh
```

## è‡ªå®šä¹‰è·¯å¾„

å¦‚éœ€è‡ªå®šä¹‰è·¯å¾„ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡åé‡æ–°æ„å»ºï¼š

```bash
export OPENCLAW_INSTALL_DIR=/path/to/openclaw
export OPENCLAW_CONFIG_DIR=/path/to/.openclaw
export OUTPUT_DIR=/path/to/output
./scripts/build-portable.sh
```

## æ•…éšœæ’é™¤

### Node.js æœªæ‰¾åˆ°
è¿è¡Œ `./install-node.sh` å®‰è£… Node.js 22.x

### æƒé™ä¸è¶³
```bash
chmod +x */start.sh install-*.sh check-*.sh
```

## ä½œè€…

zfanmy-æ¢¦æœˆå„¿

## ç‰ˆæœ¬

v1.0.1 - ä¿®å¤ç¡¬ç¼–ç è·¯å¾„ï¼Œæ”¯æŒç¯å¢ƒå˜é‡é…ç½®
READMEOF

    echo "  âœ… README.md"
}

# æ˜¾ç¤ºç»“æœ
show_result() {
    echo ""
    echo "=========================================="
    echo "âœ… æ„å»ºå®Œæˆï¼"
    echo "=========================================="
    echo ""
    echo "ğŸ“ è¾“å‡ºç›®å½•: $OUTPUT_DIR"
    echo ""
    echo "æ–‡ä»¶åˆ—è¡¨:"
    ls -la "$OUTPUT_DIR/"
    echo ""
    echo "ç›®å½•å¤§å°:"
    du -sh "$OUTPUT_DIR/clean" "$OUTPUT_DIR/full" 2\>/dev/null || true
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  cd $OUTPUT_DIR"
    echo "  ./check-env.sh       # æ£€æŸ¥ç¯å¢ƒ"
    echo "  ./clean/start.sh     # å¯åŠ¨çº¯å‡€ç‰ˆ"
    echo "  ./full/start.sh      # å¯åŠ¨å®Œæ•´ç‰ˆ"
}

# ä¸»å‡½æ•°
main() {
    check_deps
    check_source
    show_config
    prepare
    build_clean
    build_full
    create_aux
    create_readme
    show_result
}

main "$@"
